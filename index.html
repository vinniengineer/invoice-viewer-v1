<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Invoice</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <style>
    :root{ --bg:#fff; --text:#000; --line:#e5e7eb; }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      font-size:14px;
    }
    .sheet{ max-width:1024px; margin:20px auto; padding:20px; }
    header{ display:grid; grid-template-columns:1fr 1fr; gap:24px; align-items:start }
    .title{ font-weight:700; font-size:24px; margin:0 0 6px }
    .date{ font-size:12px; }
    .meta{ display:grid; grid-template-columns:auto 1fr; column-gap:10px; row-gap:6px; font-size:13px }
    .brand{ display:flex; gap:10px; align-items:center; }
    .logo-box{ width:56px; height:56px; display:grid; place-items:center }
    .company-name{ font-weight:700; font-size:18px; margin:0 }
    h3{ margin:24px 0 10px; font-size:18px }

    /* Table */
    .items-wrap{ margin-top:8px }
    table.items{ width:100%; border-collapse:collapse; table-layout:fixed; }
    .items col:nth-child(1){ width:52% }
    .items col:nth-child(2),
    .items col:nth-child(3),
    .items col:nth-child(4){ width:16% }
    .items thead th{
      font-size:12px; text-transform:uppercase; letter-spacing:.04em;
      text-align:left; padding:10px 8px; border-bottom:1px solid var(--line);
    }
    .items thead th.num{ text-align:right }
    .items tbody td{
      padding:12px 8px; border-bottom:1px solid #f2f2f2;
    }
    .items td.num{ text-align:right; white-space:nowrap; }

    /* Totals */
    .card{ border:1px solid var(--line); border-radius:12px; padding:12px 14px; background:#fff; text-align:center }
    .card h4{ margin:0 0 6px; font-size:12px; text-transform:uppercase; letter-spacing:.04em }
    .value{ font-size:18px; font-weight:700 }
    .totals2{ display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-top:16px }
    .stack{ display:grid; gap:16px }
    .tall{ display:grid; align-content:center; row-gap:6px }

    /* Footer (under right column) */
    .footer-grid{ display:grid; grid-template-columns:1fr 1fr; margin-top:16px }
    .right-sign{ display:grid; justify-items:center; row-gap:10px }
    .thanks{ font-weight:600 }
    .signature{ height:72px; width:220px; display:grid; place-items:center }
    .signature img{ max-width:100%; max-height:72px; object-fit:contain }
    .signer{ font-size:12px; text-align:center }

    @page { size: A4; margin: 16mm; }
    @media print {
      html, body { height: auto !important; }
      .sheet { width: 178mm; margin: 0 auto !important; padding: 0 !important; }
      body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    }
  </style>
</head>
<body>
  <div class="sheet">
    <header>
      <div>
        <div class="date" id="invoice_date"></div>
        <h1 class="title" id="inv_title">Invoice</h1>
        <div class="meta" style="margin-top:8px">
          <div>Client</div>       <div id="client_name"></div>
          <div>Business N.</div>  <div id="client_business_number"></div>
          <div>Phone</div>        <div id="client_phone"></div>
          <div>Email</div>        <div id="client_email"></div>
          <div>Work</div>         <div id="invoice_description"></div>
        </div>
      </div>

      <div>
        <div class="brand" style="margin-bottom:6px">
          <div class="logo-box" id="from_logo_box"></div>
          <div class="company-name" id="from_name"></div>
        </div>
        <div class="meta">
          <div>Business N.</div>  <div id="from_business_no"></div>
          <div>Address</div>      <div id="from_address"></div>
          <div>Phone</div>        <div id="from_phone"></div>
          <div>Email</div>        <div id="from_email"></div>
          <div>Web</div>          <div id="from_web"></div>
        </div>
        <div class="meta" style="margin-top:10px">
          <div>Bank</div>         <div id="bank_name"></div>
          <div>Acc Name</div>     <div id="bank_acc_name"></div>
          <div>Acc No.</div>      <div id="bank_acc_no"></div>
          <div>Routing</div>      <div id="bank_routing"></div>
        </div>
      </div>
    </header>

    <h3>Description of the Work</h3>
    <div class="items-wrap">
      <table class="items">
        <colgroup><col><col><col><col></colgroup>
        <thead>
          <tr>
            <th>Task Title</th>
            <th class="num">Price / Hourly Rate</th>
            <th class="num">Cost Qty</th>
            <th class="num">Cost Total</th>
          </tr>
        </thead>
        <tbody id="items_body"></tbody>
      </table>
    </div>

    <div class="totals2">
      <div class="stack">
        <div class="card">
          <h4>Subtotal Invoice</h4>
          <div class="value" id="subtotal">$0.00</div>
        </div>
        <div class="card">
          <h4>Taxes <span id="tax_rate_label"></span></h4>
          <div class="value" id="taxes">$0.00</div>
        </div>
      </div>
      <div class="card tall">
        <h4>Total Invoice</h4>
        <div class="value" id="grand_total">$0.00</div>
      </div>
    </div>

    <div class="footer-grid">
      <div></div>
      <div class="right-sign">
        <div class="thanks">Thank you!</div>
        <div class="signature"><img id="signature" alt=""></div>
        <div class="signer" id="signer"></div>
      </div>
    </div>
  </div>

  <script>
    const qp = new URLSearchParams(location.search);
    const get = (k, d='') => qp.get(k) ?? d;
    const ccy = get('ccy','AUD');
    const clean = v => { if(v==null||v==='') return 0; const n = parseFloat(String(v).replace(/[^0-9.-]/g,'')); return isNaN(n)?0:n; };
    const money = n => Number(n||0).toLocaleString(undefined,{style:'currency',currency:ccy});
    const fill = (id, key) => { const el = document.getElementById(id); if (el) el.textContent = get(key,''); };
    const esc  = s => String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

    // Title & Date
    const invNum = get('invoice_number','');
    document.getElementById('inv_title').textContent = invNum ? `Invoice ${invNum}` : 'Invoice';
    document.title = invNum ? `Invoice ${invNum}` : 'Invoice';
    (function(){
      const raw = get('invoice_date',''); let out = raw;
      const d = new Date(raw);
      if (!isNaN(d.getTime())){
        const day = String(d.getDate()).padStart(2,'0');
        const months = ["January","February","March","April","May","June","July","August","September","October","November","December"];
        out = `${day} ${months[d.getMonth()]} ${d.getFullYear()}`;
      }
      if(out) document.getElementById('invoice_date').textContent = `Date: ${out}`;
    })();

    // Client/Company/Bank
    ['client_name','client_business_number','client_phone','client_email','invoice_description',
     'from_name','from_business_no','from_address','from_phone','from_email','from_web',
     'bank_name','bank_acc_name','bank_acc_no','bank_routing'
    ].forEach(k => fill(k,k));

    const logo = get('from_logo','');
    if (logo) document.getElementById('from_logo_box').innerHTML =
      `<img src="${logo}" alt="logo" style="max-width:100%;max-height:100%;object-fit:contain;border-radius:8px;">`;

    // Robust decode → split items
    function deepDecode(s){
      if(s==null) return '';
      let out = String(s);
      for(let i=0;i<3;i++){
        try{ const d = decodeURIComponent(out); if(d===out) break; out=d; } catch{ break; }
      }
      return out;
    }
    function parseItems(raw){
      if(!raw) return [];
      const s = deepDecode(raw);
      return s.split('||').filter(Boolean).map(r=>{
        const [title='', price='', qty='', total=''] = r.split('::');
        const num = v => { if(v==null||v==='') return 0; const n=parseFloat(String(v).replace(/[^0-9.-]/g,'')); return isNaN(n)?0:n; };
        return { title: deepDecode(title)||'', price: num(price), qty: parseFloat(qty)||0, total: num(total) };
      });
    }

    const items = parseItems(get('items',''));
    const tbody = document.getElementById('items_body');
    let subtotalFromItems = 0;
    items.forEach(it=>{
      subtotalFromItems += it.total || 0;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${esc(it.title)}</td>
        <td class="num">${money(it.price)}</td>
        <td class="num">${(it.qty ?? 0).toLocaleString()}</td>
        <td class="num">${money(it.total)}</td>`;
      tbody.appendChild(tr);
    });

    // Totals (auto if missing)
    let subtotal = clean(get('subtotal','')); if(!subtotal && subtotalFromItems) subtotal = subtotalFromItems;
    let taxRate = get('tax_rate',''); taxRate = taxRate==='' ? '' : Number(String(taxRate).replace('%','')); if(taxRate && taxRate>1) taxRate/=100;
    let taxes = clean(get('taxes','')); if(!taxes && typeof taxRate==='number' && !isNaN(taxRate)) taxes = subtotal*taxRate;
    let grand = clean(get('grand_total','')); if(!grand) grand = subtotal + taxes;
    document.getElementById('subtotal').textContent = money(subtotal);
    document.getElementById('taxes').textContent    = money(taxes);
    document.getElementById('tax_rate_label').textContent = (taxRate||taxRate===0) ? `(${(taxRate*100).toFixed(0)}%)` : '';
    document.getElementById('grand_total').textContent = money(grand);

    // Signature
    const sig = get('signature',''); if(sig) document.getElementById('signature').src = sig;
    const signer = [get('signer_name',''), get('signer_role','')].filter(Boolean).join(' · ');
    if (signer) document.getElementById('signer').textContent = signer;

    // Auto-print (optional)
    // window.addEventListener('load', () => { try { setTimeout(() => window.print(), 0); } catch {} });
  </script>
</body>
</html>
