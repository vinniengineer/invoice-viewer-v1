<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Invoice</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <style>
    :root{ --bg:#fff; --text:#000; --line:#e5e7eb; }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      font-size:14px;
    }
    a,a:visited,a:hover,a:active{ color:#000; text-decoration:none; }

    .sheet{ max-width:1024px; margin:20px auto; padding:20px; }
    header{ display:grid; grid-template-columns:1fr 1fr; gap:24px; align-items:start }
    .title{ font-weight:700; font-size:24px; margin:0 0 6px }
    .date{ font-size:12px; }
    .meta{ display:grid; grid-template-columns:auto 1fr; column-gap:10px; row-gap:6px; font-size:13px }
    .label{ color:var(--text) }
    .brand{ display:flex; gap:10px; align-items:center; }
    .logo-box{ width:56px; height:56px; display:grid; place-items:center }
    .company-name{ font-weight:700; font-size:18px; margin:0 }

    /* visual line break inside meta grids */
    .break { height:8px }
    .break + .break { height:8px } /* keep grid balanced (two cols) */

    h3{ margin:20px 0 10px; font-size:18px }

    /* Items table */
    .items-wrap{ margin-top:8px }
    table.items{ width:100%; border-collapse:collapse; }
    .items thead th{
      font-size:12px; text-transform:uppercase; letter-spacing:.04em;
      padding:6px 8px; border-bottom:1px solid var(--line);
    }
    .items thead th:first-child{ text-align:left; }
    .items thead th.num{ text-align:right; }
    .items thead th.num-left{ text-align:left; }   /* for Price header */
    .items tbody td{
      padding:8px 8px;       /* a bit tighter to fit more rows */
      border-bottom:1px solid #f2f2f2;
      vertical-align:middle;
    }
    .items td.num{ text-align:right; white-space:nowrap; }
    .items td.qty{ text-align:center; }

    /* Totals cards */
    .card{ border:1px solid var(--line); border-radius:12px; padding:12px 14px; background:#fff; text-align:center }
    .card h4{ margin:0 0 6px; font-size:12px; text-transform:uppercase; letter-spacing:.04em }
    .value{ font-size:18px; font-weight:700 }
    .totals2{ display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-top:16px }
    .stack{ display:grid; gap:16px }
    .tall{ display:grid; align-content:center; row-gap:6px }

    /* Footer aligned under right column */
    .footer-grid{ display:grid; grid-template-columns:1fr 1fr; margin-top:16px }
    .right-sign{ display:grid; justify-items:center; row-gap:10px }
    .thanks{ font-weight:600 }
    .signature{ height:72px; width:220px; display:grid; place-items:center }
    .signature img{ max-width:100%; max-height:72px; object-fit:contain }
    .signer{ font-size:12px; text-align:center }

    /* Print */
    @page { size: A4; margin: 16mm; }
    @media print {
      html, body { height: auto !important; }
      .sheet { width: 178mm; margin: 0 auto !important; padding: 0 !important; }
      body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    }
  </style>
</head>
<body>
  <div class="sheet">
    <header>
      <!-- LEFT: Client -->
      <div>
        <div class="date" id="invoice_date"></div>
        <h1 class="title" id="inv_title">Invoice</h1>
        <div class="meta" style="margin-top:8px">
          <div class="label">Client</div>        <div id="client_name"></div>
          <div class="label">Business N.</div>    <div id="client_business_number"></div>
          <div class="label">Phone</div>         <div id="client_phone"></div>
          <div class="label">Email</div>         <div id="client_email"></div>

          <!-- visual <br> under client email before Work -->
          <div class="break"></div>              <div class="break"></div>

          <div class="label">Work</div>          <div id="invoice_description"></div>
        </div>
      </div>

      <!-- RIGHT: Company -->
      <div>
        <div class="brand" style="margin-bottom:6px">
          <div class="logo-box" id="from_logo_box"></div>
          <div class="company-name" id="from_name"></div>
        </div>

        <div class="meta">
          <div class="label">Business N.</div>   <div id="from_business_no"></div>
          <div class="label">Address</div>       <div id="from_address"></div>
          <div class="label">Phone</div>         <div id="from_phone"></div>
          <div class="label">Email</div>         <div id="from_email"></div>
          <div class="label">Web</div>           <div id="from_web"></div>
        </div>

        <div class="meta" id="bank_block" style="margin-top:10px">
          <div class="label">Bank</div>          <div id="bank_name"></div>
          <div class="label">Acc Name</div>      <div id="bank_acc_name"></div>
          <div class="label">Acc No.</div>       <div id="bank_acc_no"></div>
          <div class="label">Routing</div>       <div id="bank_routing"></div>
        </div>
      </div>
    </header>

    <!-- Items -->
    <h3>Description of the Work</h3>
    <div class="items-wrap">
      <table class="items">
        <thead>
          <tr>
            <th>Task Title</th>
            <th class="num-left">Price / Hourly Rate</th>
            <th class="num">Cost Qty</th>
            <th class="num">Cost Total</th>
          </tr>
        </thead>
        <tbody id="items_body"></tbody>
      </table>
    </div>

    <!-- Totals -->
    <div class="totals2">
      <div class="stack">
        <div class="card">
          <h4>Subtotal Invoice</h4>
          <div class="value" id="subtotal">$0.00</div>
        </div>
        <div class="card">
          <h4>Taxes <span id="tax_rate_label"></span></h4>
          <div class="value" id="taxes">$0.00</div>
        </div>
      </div>

      <div class="card tall">
        <h4>Total Invoice</h4>
        <div class="value" id="grand_total">$0.00</div>
      </div>
    </div>

    <!-- Footer under right column -->
    <div class="footer-grid">
      <div></div>
      <div class="right-sign" id="sign_block">
        <div class="thanks">Thank you!</div>
        <div class="signature"><img id="signature" alt=""></div>
        <div class="signer" id="signer"></div>
      </div>
    </div>
  </div>

  <script>
    // ---- helpers
    const qp = new URLSearchParams(location.search);
    const get = (k, d='') => qp.get(k) ?? d;
    const ccy = get('ccy','AUD');

    const clean = v => {
      if(v==null||v==='') return 0;
      const n = parseFloat(String(v).replace(/[^0-9.-]/g,''));
      return isNaN(n)?0:n;
    };
    const money = n => Number(n||0).toLocaleString(undefined,{style:'currency',currency:ccy});
    const esc = s => String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

    // fill or hide label+value if empty
    function fillOrHide(valueId, qpKey) {
      const v = (get(qpKey, '') || '').trim();
      const el = document.getElementById(valueId);
      if (!el) return;

      if (v) {
        el.textContent = v;
        el.style.display = '';
        if (el.previousElementSibling && el.previousElementSibling.classList.contains('label')) {
          el.previousElementSibling.style.display = '';
        }
      } else {
        el.textContent = '';
        el.style.display = 'none';
        if (el.previousElementSibling && el.previousElementSibling.classList.contains('label')) {
          el.previousElementSibling.style.display = 'none';
        }
      }
    }

    // ---- title, date
    const invNum = get('invoice_number','');
    document.getElementById('inv_title').textContent = invNum ? `Invoice ${invNum}` : 'Invoice';
    document.title = invNum ? `Invoice ${invNum}` : 'Invoice';

    (function formatDate(){
      const raw = get('invoice_date','');
      let out = raw;
      const d = new Date(raw);
      if (!isNaN(d.getTime())) {
        const day = String(d.getDate()).padStart(2,'0');
        const months = ["January","February","March","April","May","June","July","August","September","October","November","December"];
        out = `${day} ${months[d.getMonth()]} ${d.getFullYear()}`;
      }
      if (out) document.getElementById('invoice_date').textContent = `Date: ${out}`;
    })();

    // ---- client (show/hide when empty)
    fillOrHide('client_name','client_name');
    fillOrHide('client_business_number','client_business_number');
    fillOrHide('client_phone','client_phone');
    fillOrHide('client_email','client_email');
    fillOrHide('invoice_description','invoice_description');

    // ---- company + bank (show/hide when empty)
    fillOrHide('from_name','from_name');
    fillOrHide('from_business_no','from_business_no');
    fillOrHide('from_address','from_address');
    fillOrHide('from_phone','from_phone');
    fillOrHide('from_email','from_email');
    fillOrHide('from_web','from_web');

    fillOrHide('bank_name','bank_name');
    fillOrHide('bank_acc_name','bank_acc_name');
    fillOrHide('bank_acc_no','bank_acc_no');
    fillOrHide('bank_routing','bank_routing');

    // If all bank fields are hidden, hide the entire bank block
    (function maybeHideBankBlock(){
      const block = document.getElementById('bank_block');
      if (!block) return;
      const visible = Array.from(block.children).some(el => el.style.display !== 'none');
      if (!visible) block.style.display = 'none';
    })();

    // logo (optional)
    const logo = get('from_logo','').trim();
    if (logo) {
      document.getElementById('from_logo_box').innerHTML =
        `<img src="${logo}" alt="logo" style="max-width:100%;max-height:100%;object-fit:contain;border-radius:8px;">`;
    }

    // ---- items: split "row||row" and "title::price::qty::total"
    function parseItems(str){
      if(!str) return [];
      const rowSep = /(\|\||%7C%7C)/i;       // || or URL-encoded
      const colSep = /(::|%3A%3A)/i;         // :: or URL-encoded
      return str.split(rowSep).filter(s => !rowSep.test(s) && s !== '')
        .map(row => {
          const fields = row.split(colSep).filter(s => !colSep.test(s));
          const [title='', price='', qty='', total=''] = fields;
          return {
            title: decodeURIComponent(title || ''),
            price: clean(price),
            qty:   parseFloat(qty || 0) || 0,
            total: clean(total)
          };
        });
    }

    const items = parseItems(get('items',''));
    const tbody = document.getElementById('items_body');
    let subtotalFromItems = 0;

    items.forEach(it => {
      subtotalFromItems += it.total || 0;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${esc(it.title)}</td>
        <td class="num-left">${money(it.price)}</td>
        <td class="qty">${(it.qty ?? 0).toLocaleString()}</td>
        <td class="num">${money(it.total)}</td>`;
      tbody.appendChild(tr);
    });

    // ---- totals (auto if missing)
    let subtotal = clean(get('subtotal',''));
    if (!subtotal && subtotalFromItems) subtotal = subtotalFromItems;

    let taxRate = get('tax_rate','');
    taxRate = taxRate === '' ? '' : Number(String(taxRate).replace('%',''));
    if (taxRate && taxRate > 1) taxRate = taxRate / 100;

    let taxes = clean(get('taxes',''));
    if (!taxes && typeof taxRate === 'number' && !isNaN(taxRate)) taxes = subtotal * taxRate;

    let grand = clean(get('grand_total',''));
    if (!grand) grand = subtotal + taxes;

    document.getElementById('subtotal').textContent = money(subtotal);
    document.getElementById('taxes').textContent = money(taxes);
    document.getElementById('tax_rate_label').textContent =
      (taxRate || taxRate===0) ? `(${(taxRate*100).toFixed(0)}%)` : '';
    document.getElementById('grand_total').textContent = money(grand);

    // ---- signature (hide block if both missing)
    const sig = get('signature','').trim();
    const signerText = [get('signer_name','').trim(), get('signer_role','').trim()].filter(Boolean).join(' · ');

    if (sig) document.getElementById('signature').src = sig;
    if (signerText) document.getElementById('signer').textContent = signerText;
    if (!sig && !signerText) {
      const signBlock = document.getElementById('sign_block');
      if (signBlock) signBlock.style.display = 'none';
    }

    // ---- auto-print when print=1 or print=true
    const autoPrint = /^(1|true)$/i.test(get('print','').trim());
    if (autoPrint) {
      window.addEventListener('load', () => {
        try { setTimeout(() => window.print(), 0); } catch {}
      });
    }
  </script>
</body>
</html>
